#!/usr/bin/env bash
set -euo pipefail

# nix-darwin setup (local flake mode)
# Assumes your repo already exists at ~/nix (or a path you provide).

if [[ "$(uname -s)" != "Darwin" ]]; then
  echo "This script is for macOS (Darwin) only."
  exit 1
fi

echo -e "\033[1;34m"
cat <<'EOF'
                ___          ______         ___               
               J@@@@,        '@@@@@@,     ,@@@@p              
               @@@B@@L        `@@@@@@_   ,@@@@@@              
                Q@ '@@L         @@@@@@L /@@@@@@               
              ., ?jlT@:_        _0'q,@@@@@@@@W                
          ___,9=._  _@_",,__,,@P==4@p_%@@g_'F                 
         /@@@.'@@@,|[@@@',@@j[@P"_~gg_%_%@@@g       ,a        
        A@@@@.'@@@|@'@@@ @|@@L ,@@@"_",q\@@@4`    ,@@@       
       """""" l""""[."""_F'""";"@@"_g,o[|g@@ g@@@'/@@@@@      
              '0qa~gLgmD'   gp._@ @@BB|][@@@'@@@"/@@@@@D      
                Jgg'|gP  '"_~g@g' @gq'@ @@@@@@" @@@@@@P       
               @@@@ g"      %g@L@b__"4N!@@@@B' @@@@@@/        
  _ggggggggggg@@@@@ @         "*==>",''@@. _/,@@@@@@ggggggggp 
 g@@@@@@@@@@@@@@@@@ B,        +@D._    @@   _@@@@@@@@@@@@@@@@@
 '@@@@@@@@@@@@@@@@ ,  B_    _'_"_.@g_  @@@ /@@@@@@@@@@@@@@@@@/
          [@@@@@D @,  [@@@@W,@@@@[Q@@@_ " _@@@@@P             
         g@@@@@P @@@|| @@@@,@@@@@'a'@@@g @@@@@@F              
        @@@@@@/ `@@@ g[,   @@@@@@,@@ _S@ @@@@@/               
      .@@@@@@/    @@.@|@\  @@@@@@@ @@_..BBBBP                 
       \@@@@       Q @ @@L @@@@@@@ @@@l9@@@@@@@@@@@@@@@F      
        '@@         ,@:@@ @ @@@@@P_@@@@|@@@@@@@@@@@@@@/       
                   A]9 @1<@@g_%W,@@@@@ >__g@@@> @@@@@         
                  @@g[| ,  q~~Z %@@@k,<4mmBP>'                
                 @@@@__ ___g@@ _~_,"_" '@@@@@@,               
               _@@@@@@   @@@@@@L   >     @@@@@@L              
               @@@@@@     %@@@@@g         Q@@@@@`             
                @@BP       "BBBBBB         t@@B               
EOF
echo -e "\033[0m"

echo "ðŸš€ Doug's nix-darwin setup (local repo mode)"
echo "ðŸ“ Assumes your nix repo already exists locally."
echo

default_repo_dir="$HOME/nix"
default_host="Dougs-Virtual-Machine"
default_wallpaper="$HOME/dotfiles/wallpapers/solid-1C1C1E.ppm"

read -r -p "Local nix repo path [${default_repo_dir}]: " REPO_DIR
REPO_DIR="${REPO_DIR:-$default_repo_dir}"

read -r -p "Flake host key [${default_host}]: " HOST_NAME
HOST_NAME="${HOST_NAME:-$default_host}"

read -r -p "Wallpaper file path [${default_wallpaper}]: " WALLPAPER_FILE
WALLPAPER_FILE="${WALLPAPER_FILE:-$default_wallpaper}"

echo
echo "Choose execution mode:"
echo "  1) Guided (prompt before each step)"
echo "  2) Print-only (you run commands manually)"
read -r -p "Mode [1/2]: " MODE
MODE="${MODE:-1}"

step_verify_repo() {
  test -d "$REPO_DIR"
  test -f "$REPO_DIR/flake.nix"
}

step_load_nix_profile() {
  if [[ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]]; then
    # shellcheck source=/dev/null
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  else
    echo "Nix daemon profile not found."
    return 1
  fi
}

step_create_wallpaper() {
  mkdir -p "$(dirname "$WALLPAPER_FILE")"
  cat > "$WALLPAPER_FILE" <<'EOF'
P3
1 1
255
28 28 30
EOF
}

step_apply_wallpaper() {
  osascript <<EOF
tell application "System Events"
  tell every desktop
    set picture to "${WALLPAPER_FILE}"
  end tell
end tell
EOF
}

step_switch_darwin() {
  sudo -H nix run nix-darwin -- switch --flake "${REPO_DIR}#${HOST_NAME}"
}

run_step() {
  local title="$1"
  local preview="$2"
  local fn="$3"

  echo
  echo "==> ${title}"
  echo "    ${preview}"

  if [[ "$MODE" == "2" ]]; then
    echo "[print-only] Run the command above manually, then press Enter to continue."
    read -r _ </dev/tty
    return 0
  fi

  while true; do
    read -r -p "Run this step? [y]es/[s]kip/[q]uit: " ans </dev/tty
    case "$ans" in
      y|Y)
        "$fn"
        return 0
        ;;
      s|S)
        echo "Skipped."
        return 0
        ;;
      q|Q)
        echo "Exiting."
        exit 0
        ;;
      *)
        echo "Please enter y, s, or q."
        ;;
    esac
  done
}

echo
echo "Plan:"
echo "1) Verify local nix repo exists"
echo "2) Ensure Nix daemon profile is available in this shell"
echo "3) Create ~/dotfiles/wallpapers and solid-color wallpaper file (#1C1C1E)"
echo "4) Apply wallpaper to all desktops"
echo "5) Switch nix-darwin from local flake"
echo

read -r -p "Continue? [y/N]: " go </dev/tty
[[ "$go" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 0; }

run_step \
  "Verify local nix repo and flake" \
  "test -d '$REPO_DIR' && test -f '$REPO_DIR/flake.nix'" \
  step_verify_repo

run_step \
  "Load Nix daemon profile in this shell" \
  ". /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" \
  step_load_nix_profile

run_step \
  "Create wallpaper file ${WALLPAPER_FILE}" \
  "mkdir -p '$(dirname "$WALLPAPER_FILE")' && write ${WALLPAPER_FILE}" \
  step_create_wallpaper

run_step \
  "Apply wallpaper to all desktops" \
  "osascript (set picture to '${WALLPAPER_FILE}')" \
  step_apply_wallpaper

run_step \
  "Switch to nix-darwin config" \
  "sudo -H nix run nix-darwin -- switch --flake '${REPO_DIR}#${HOST_NAME}'" \
  step_switch_darwin

echo
echo "âœ… Done."
echo "If you skipped steps, run them manually before logging out/rebooting."
